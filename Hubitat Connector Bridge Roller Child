// Ver 4.2 - Data alignment + state cleanup

metadata {
    definition(
        name: "Connector Bridge Roller Child",
        namespace: "Connector",
        author: "ScubaMikeJax904",
        importUrl: "https://raw.githubusercontent.com/scubamikejax904/Connector-Hubitat-Relay/refs/heads/main/Hubitat%20Connector%20Bridge%20Roller%20Child"
    ) {
        capability "WindowShade"
        capability "Switch"
        capability "SwitchLevel"
        capability "Battery"
        capability "Refresh"

        command "stop"

        attribute "rssi", "number"
        attribute "online", "string"
        attribute "lastUpdate", "string"
    }
}

// ------------------- Capability Commands -------------------
def open() {
    parent.sendOpenCommand(device.deviceNetworkId)
    sendEvent(name: "windowShade", value: "opening")
    sendEvent(name: "switch", value: "on")
}

def close() {
    parent.sendCloseCommand(device.deviceNetworkId)
    sendEvent(name: "windowShade", value: "closing")
    sendEvent(name: "switch", value: "off")
}

def stop() {
    parent.sendStopCommand(device.deviceNetworkId)
    sendEvent(name: "windowShade", value: "partially open")
}

def setLevel(level) {
    level = Math.max(Math.min(level as int, 100), 0)
    parent.sendTargetCommand(device.deviceNetworkId, level)
    sendEvent(name: "level", value: level)

    updateShadeFromPosition(level)
}

def setPosition(pos) {
    setLevel(pos as int)
}

def refresh() {
    parent.requestStatus(device.deviceNetworkId)
}

// ------------------- State Updates from Parent -------------------
def updateStateFromParent(deviceData) {
    if (!deviceData) {
        log.warn "No device data received for ${device.displayName}"
        return
    }

    if (logEnable) {
        log.debug "Processing device data for ${device.displayName}: ${deviceData}"
    }

    // ---- Position ----
    if (deviceData.currentPosition != null) {
        def position = deviceData.currentPosition as int
        sendEvent(name: "level", value: position)
        updateShadeFromPosition(position)
    }

    // ---- Operation (live motion state) ----
    if (deviceData.operation != null) {
        switch (deviceData.operation as int) {
            case 0:
                sendEvent(name: "windowShade", value: "closing")
                break
            case 1:
                sendEvent(name: "windowShade", value: "opening")
                break
            case 2:
                sendEvent(name: "windowShade", value: "partially open")
                break
        }
    }

    // ---- Battery ----
    if (deviceData.batteryLevel != null) {
        sendEvent(name: "battery", value: deviceData.batteryLevel as int)
    }

    // ---- RSSI (matches parent: data.raw.RSSI) ----
    if (deviceData.raw?.RSSI != null) {
        sendEvent(name: "rssi", value: deviceData.raw.RSSI as int)
    }

    // ---- Timestamps / online ----
    sendEvent(
        name: "lastUpdate",
        value: new Date().format("yyyy-MM-dd HH:mm:ss", location.timeZone)
    )
    sendEvent(name: "online", value: "online")
}

// ------------------- Helpers -------------------
private updateShadeFromPosition(int position) {
    if (position <= 0) {
        sendEvent(name: "windowShade", value: "open")
        sendEvent(name: "switch", value: "on")
    } else if (position >= 100) {
        sendEvent(name: "windowShade", value: "closed")
        sendEvent(name: "switch", value: "off")
    } else {
        sendEvent(name: "windowShade", value: "partially open")
        sendEvent(name: "switch", value: "on")
    }
}

def markOffline() {
    sendEvent(name: "online", value: "offline")
}
